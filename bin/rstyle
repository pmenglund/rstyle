#!/usr/bin/env ruby
#
# Copyright 2011 Code Nursery AB. All rights reserved.
# Use is subject to license terms.
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

if File.symlink?($0) && $0 =~ /pre-commit/
  prog = %x{pwd}.chomp + "/.git/hooks/" + File.readlink($0)
  base = File.dirname File.expand_path(prog)
elsif
  base = File.expand_path(File.dirname($0))
else
  exit 2
end

gemfile = File.expand_path("/../Gemfile", base)

if File.exists?(gemfile)
  ENV["BUNDLE_GEMFILE"] = gemfile
  require "rubygems"
  require "bundler/setup"
end

$:.unshift(File.expand_path("../lib", base))
require "rstyle"

trap("INT") { puts "Exiting..."; exit(0) }

s = Rstyle.new

if ARGV.length == 0
  files = []
  %x{git status --short --untracked-files=no 2>&1}.split("\n").each do |line|
    unless $? == 0
      $stderr.puts "failed to execute 'git status'"
      exit 2
    end
    if line =~ /^[MA].\s(.+)\S*$/
      files << $1
    end
  end
  s.source(files)
else
  s.source(ARGV)
end

exit 1 unless s.errors == 0
